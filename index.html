<!DOCTYPE html>
<html>

  <head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>OpenCV FaceDetect</title>
    <script async src='opencv.js' onload='openCvReady();'></script>
    <script src='utils.js'></script>
  </head>

  <body>
    <video id='cam_input' height='480' width='640'></video>
    <canvas id='canvas_output'></canvas>

    <script>
      function openCvReady() {
        cv['onRuntimeInitialized'] = () => {
          let video = document.getElementById('cam_input');
          // using WebRTC to get media stream
          navigator.mediaDevices.getUserMedia({ video: true, audio: false })
            .then(function (stream) {
              video.srcObject = stream;
              video.play();
            })
            .catch(function (err) {
              console.log('An error has occured! ' + err);
            });

          let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
          let gray = new cv.Mat();
          let cap = new cv.VideoCapture(cam_input);
          let faces = new cv.RectVector();
          let classifier = new cv.CascadeClassifier();
          let utils = new Utils('errorMessage');
          let faceCascade = 'haarcascade_frontalface_default.xml';
          utils.createFileFromUrl(faceCascade, faceCascade, () => {
            classifier.load(faceCascade);
          });

          const FPS = 30;
          function processVideo() {
            let begin = Date.now();
            cap.read(src);
            cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY, 0);
            try {
              classifier.detectMultiScale(gray, faces, 1.1, 3, 0);
            } catch (err) {
              console.log(err);
            }

            for (let i = 0; i < faces.size(); ++i) {
              let face = faces.get(i);
              let point1 = new cv.Point(face.x, face.y);
              let point2 = new cv.Point(face.x + face.width, face.y + face.height);
              cv.rectangle(src, point1, point2, [255, 0, 0, 255]);
            }

            cv.imshow('canvas_output', src);

            let delay = 1000 / FPS - (Date.now() - begin);
            // schedule next one
            setTimeout(processVideo, delay);
          }

          // schedule first one 
          setTimeout(processVideo, 0);
        }
      }
    </script>
  </body>
  
</html>